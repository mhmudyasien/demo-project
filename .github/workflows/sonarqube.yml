name: Main Workflow

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'releases/**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarqube:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # Checkout Code
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for SonarQube PR analysis

    # -----------------------------
    # Secret Check
    # -----------------------------
    - name: Check SONAR_TOKEN secret
      run: |
        if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
          echo "❌ SONAR_TOKEN is not set"
          exit 1
        fi
        echo "✅ SONAR_TOKEN is set"

    # -----------------------------
    # Config Check
    # -----------------------------
    - name: Check Sonar config file
      run: |
        if [ ! -f sonar-project.properties ]; then
          echo "❌ sonar-project.properties not found"
          exit 1
        fi
        echo "✅ sonar-project.properties found"

    # -----------------------------
    # Python Setup (for linting)
    # -----------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # -----------------------------
    # Install Linting Tools
    # -----------------------------
    - name: Install flake8
      run: |
        python -m pip install --upgrade pip
        pip install flake8

    # -----------------------------
    # Linting Check
    # -----------------------------  
    - name: Run flake8 linting
      run: |
        flake8 . \
        --count \
        --select=E9,F63,F7 \
        --show-source \
        --statistics

    # -----------------------------
    # SonarQube / SonarCloud Scan (SINGLE SCAN)
    # -----------------------------
    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v7.0.0
      env:
        SONAR_TOKEN: ${{ secrets.TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      # No 'with' inputs needed — uses sonar-project.properties automatically
