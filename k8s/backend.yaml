apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: cloud-ninjas
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "backend-role"
        vault.hashicorp.com/agent-inject-secret-backend-env.sh: "secret/data/backend-secret"
        vault.hashicorp.com/agent-inject-template-backend-env.sh: |
          {{- with secret "secret/data/backend-secret" -}}
          export DB_HOST="{{ .Data.data.DB_HOST }}"
          export DB_NAME="{{ .Data.data.DB_NAME }}"
          export DB_USER="{{ .Data.data.DB_USER }}"
          export DB_PASS="{{ .Data.data.DB_PASS }}"
          export REDIS_HOST="{{ .Data.data.REDIS_HOST }}"
          {{- end }} 
    spec:

      serviceAccountName: backend-serviceaccount
      containers:
      - name: backend
        image: selconyt/backend:v1.0
        command: ["/bin/sh", "-c"]
        args:
          - |
            source /vault/secrets/backend-env.sh
            uvicorn main:app --host 0.0.0.0 --port 8000
        # No env section needed â€” all from Vault
        ports:
        - containerPort: 8000
